import{c as K,o as fe}from"./vendor__J-4d216d94.js";import{c as b,a as p,s as T,i as P}from"./vendor__X-0a90856f.js";import{b as L}from"./vendor__A-52efc0b7.js";import{p as me}from"./vendor__G-662858fe.js";var pe=Object.defineProperty,ge=Object.defineProperties,Ee=Object.getOwnPropertyDescriptors,j=Object.getOwnPropertySymbols,ae=Object.prototype.hasOwnProperty,ce=Object.prototype.propertyIsEnumerable,B=(s,e,r)=>e in s?pe(s,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[e]=r,_=(s,e)=>{for(var r in e||(e={}))ae.call(e,r)&&B(s,r,e[r]);if(j)for(var r of j(e))ce.call(e,r)&&B(s,r,e[r]);return s},N=(s,e)=>ge(s,Ee(e)),le=(s,e)=>{var r={};for(var t in s)ae.call(s,t)&&e.indexOf(t)<0&&(r[t]=s[t]);if(s!=null&&j)for(var t of j(s))e.indexOf(t)<0&&ce.call(s,t)&&(r[t]=s[t]);return r};const U="nhostRefreshToken",D="nhostRefreshTokenExpiresAt",Te=3,ve=300,_e=5,we=0,w=10,G=20,k={status:w,error:"invalid-email",message:"Email is incorrectly formatted"},F={status:w,error:"invalid-password",message:"Password is incorrectly formatted"},Q={status:w,error:"invalid-phone-number",message:"Phone number is incorrectly formatted"},Se={status:w,error:"invalid-mfa-ticket",message:"MFA ticket is invalid"},Oe={status:w,error:"no-mfa-ticket",message:"No MFA ticket has been provided"},ke={status:w,error:"no-refresh-token",message:"No refresh token has been provided"},Ie={status:G,error:"refresher-already-running",message:"The token refresher is already running. You must wait until is has finished before submitting a new token."},S={status:G,error:"already-signed-in",message:"User is already signed in"},ye={status:G,error:"unauthenticated-user",message:"User is not authenticated"},Ae={status:G,error:"unverified-user",message:"Email needs verification"},Pe={status:w,error:"invalid-refresh-token",message:"Invalid or expired refresh token"},C=s=>{const e=L.create({baseURL:s});return e.interceptors.response.use(r=>r,r=>{var t,n,i,l,u,f,g,m,E,h;return Promise.reject({error:{message:(u=(l=(i=(n=(t=r.response)==null?void 0:t.data)==null?void 0:n.message)!=null?i:r.message)!=null?l:r.request.responseText)!=null?u:JSON.stringify(r),status:(E=(m=(f=r.response)==null?void 0:f.status)!=null?m:(g=r.response)==null?void 0:g.data.statusCode)!=null?E:we,error:((h=r.response)==null?void 0:h.data.error)||r.request.statusText||"network"}})}),e},H=typeof window<"u",V=new Map,Re=s=>{var e;return H&&typeof localStorage<"u"?localStorage.getItem(s):(e=V.get(s))!=null?e:null},Ne=(s,e)=>{H&&typeof localStorage<"u"?e?localStorage.setItem(s,e):localStorage.removeItem(s):e?V.set(s,e):V.has(s)&&V.delete(s)},be=(s,e)=>{if(s==="localStorage"||s==="web")return Re;if(s==="cookie")return r=>{var t;return H&&(t=K.get(r))!=null?t:null};if(!e)throw Error(`clientStorageType is set to '${s}' but no clientStorage has been given`);if(s==="react-native")return r=>{var t;return(t=e.getItem)==null?void 0:t.call(e,r)};if(s==="capacitor")return r=>{var t;return(t=e.get)==null?void 0:t.call(e,{key:r})};if(s==="expo-secure-storage")return r=>{var t;return(t=e.getItemAsync)==null?void 0:t.call(e,r)};if(s==="custom"){if(e.getItem&&e.removeItem)return e.getItem;if(e.getItemAsync)return e.getItemAsync;throw Error(`clientStorageType is set to 'custom' but clientStorage is missing either "getItem" and "removeItem" properties or "getItemAsync" property`)}throw Error(`Unknown storage type: ${s}`)},Ce=(s,e)=>{if(s==="localStorage"||s==="web")return Ne;if(s==="cookie")return(r,t)=>{H&&(t?K.set(r,t):K.remove(r))};if(!e)throw Error(`clientStorageType is set to '${s}' but no clienStorage has been given`);if(s==="react-native")return(r,t)=>{var n,i;return t?(n=e.setItem)==null?void 0:n.call(e,r,t):(i=e.removeItem)==null?void 0:i.call(e,r)};if(s==="capacitor")return(r,t)=>{var n,i;return t?(n=e.set)==null?void 0:n.call(e,{key:r,value:t}):(i=e.remove)==null?void 0:i.call(e,{key:r})};if(s==="expo-secure-storage")return async(r,t)=>{var n,i;return t?(n=e.setItemAsync)==null?void 0:n.call(e,r,t):(i=e.deleteItemAsync)==null?void 0:i.call(e,r)};if(s==="custom"){if(!e.removeItem)throw Error("clientStorageType is set to 'custom' but clientStorage is missing a removeItem property");if(e.setItem)return(r,t)=>{var n,i;return t?(n=e.setItem)==null?void 0:n.call(e,r,t):(i=e.removeItem)==null?void 0:i.call(e,r)};if(e.setItemAsync)return async(r,t)=>{var n,i;return t?(n=e.setItemAsync)==null?void 0:n.call(e,r,t):(i=e.removeItem)==null?void 0:i.call(e,r)};throw Error("clientStorageType is set to 'custom' but clientStorage is missing setItem or setItemAsync property")}throw Error(`Unknown storage type: ${s}`)},ue=(s,e)=>{const r=e&&Object.entries(e).map(([t,n])=>{const i=Array.isArray(n)?n.join(","):typeof n=="object"?JSON.stringify(n):n;return`${t}=${encodeURIComponent(i)}`}).join("&");return r?`${s}?${r}`:s},v=(s,e)=>{if(!(e!=null&&e.redirectTo))return e;const r=e,{redirectTo:t}=r,n=le(r,["redirectTo"]);if(!s)return t.startsWith("/")?n:e;const i=new URL(s),l=Object.fromEntries(new URLSearchParams(i.search)),u=new URL(t.startsWith("/")?i.origin+t:t),f=new URLSearchParams(u.search);let g=Object.fromEntries(f);t.startsWith("/")&&(g=_(_({},l),g));let m=i.pathname;return u.pathname.length>1&&(m+=u.pathname.slice(1)),N(_({},n),{redirectTo:ue(u.origin+m,g)})};function x(s,e){var r;if(!e){if(typeof window>"u")return;e=((r=window.location)==null?void 0:r.href)||""}s=s.replace(/[\[\]]/g,"\\$&");const t=new RegExp("[?&#]"+s+"(=([^&#]*)|&|#|$)"),n=t.exec(e);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null}function Y(s){var e;if(typeof window>"u")return;const r=window==null?void 0:window.location;if(r&&r){const t=new URLSearchParams(r.search),n=new URLSearchParams((e=r.hash)==null?void 0:e.slice(1));t.delete(s),n.delete(s);let i=window.location.pathname;Array.from(t).length&&(i+=`?${t.toString()}`),Array.from(n).length&&(i+=`#${n.toString()}`),window.history.pushState({},"",i)}}const I=s=>!!s&&typeof s=="string"&&!!String(s).toLowerCase().match(/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/),z=s=>!!s&&typeof s=="string"&&s.length>=Te,J=s=>!!s&&typeof s=="string",Ue=s=>s&&typeof s=="string"&&s.match(/^mfaTotp:[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i),W={user:null,mfa:null,accessToken:{value:null,expiresAt:null},refreshTimer:{startedAt:null,attempts:0,lastAttempt:null},refreshToken:{value:null},errors:{}},De=({backendUrl:s,clientUrl:e,interpreter:r})=>{const t=C(s);return b({schema:{context:{},events:{}},tsTypes:{},preserveActionOrder:!0,id:"changeEmail",initial:"idle",context:{error:null},states:{idle:{on:{REQUEST:[{cond:"invalidEmail",actions:"saveInvalidEmailError",target:".error"},{target:"requesting"}]},initial:"initial",states:{initial:{},success:{},error:{}}},requesting:{invoke:{src:"requestChange",id:"requestChange",onDone:{target:"idle.success",actions:"reportSuccess"},onError:{actions:["saveRequestError","reportError"],target:"idle.error"}}}}},{actions:{saveInvalidEmailError:p({error:n=>k}),saveRequestError:p({error:(n,{data:{error:i}})=>i}),reportError:T(n=>({type:"ERROR",error:n.error})),reportSuccess:T("SUCCESS")},guards:{invalidEmail:(n,{email:i})=>!I(i)},services:{requestChange:async(n,{email:i,options:l})=>(await t.post("/user/email/change",{newEmail:i,options:v(e,l)},{headers:{authorization:`Bearer ${r==null?void 0:r.state.context.accessToken.value}`}})).data}})},xe=({backendUrl:s,interpreter:e})=>{const r=C(s);return b({schema:{context:{},events:{}},tsTypes:{},preserveActionOrder:!0,id:"changePassword",initial:"idle",context:{error:null},states:{idle:{on:{REQUEST:[{cond:"invalidPassword",actions:"saveInvalidPasswordError",target:".error"},{target:"requesting"}]},initial:"initial",states:{initial:{},success:{},error:{}}},requesting:{invoke:{src:"requestChange",id:"requestChange",onDone:{target:"idle.success",actions:"reportSuccess"},onError:{actions:["saveRequestError","reportError"],target:"idle.error"}}}}},{actions:{saveInvalidPasswordError:p({error:t=>F}),saveRequestError:p({error:(t,{data:{error:n}})=>n}),reportError:T(t=>({type:"ERROR",error:t.error})),reportSuccess:T("SUCCESS")},guards:{invalidPassword:(t,{password:n})=>!z(n)},services:{requestChange:(t,{password:n})=>r.post("/user/password",{newPassword:n},{headers:{authorization:`Bearer ${e==null?void 0:e.state.context.accessToken.value}`}})}})},$e=({backendUrl:s,clientUrl:e})=>{const r=C(s);return b({schema:{context:{},events:{}},tsTypes:{},preserveActionOrder:!0,id:"changePassword",initial:"idle",context:{error:null},states:{idle:{on:{REQUEST:[{cond:"invalidEmail",actions:"saveInvalidEmailError",target:".error"},{target:"requesting"}]},initial:"initial",states:{initial:{},success:{},error:{}}},requesting:{invoke:{src:"requestChange",id:"requestChange",onDone:{target:"idle.success",actions:"reportSuccess"},onError:{actions:["saveRequestError","reportError"],target:"idle.error"}}}}},{actions:{saveInvalidEmailError:p({error:t=>k}),saveRequestError:p({error:(t,{data:{error:n}})=>n}),reportError:T(t=>({type:"ERROR",error:t.error})),reportSuccess:T("SUCCESS")},guards:{invalidEmail:(t,{email:n})=>!I(n)},services:{requestChange:(t,{email:n,options:i})=>r.post("/user/password/reset",{email:n,options:v(e,i)})}})},Me=({backendUrl:s,clientUrl:e})=>{const r=C(s);return b({schema:{context:{},events:{}},tsTypes:{},preserveActionOrder:!0,id:"sendVerificationEmail",initial:"idle",context:{error:null},states:{idle:{on:{REQUEST:[{cond:"invalidEmail",actions:"saveInvalidEmailError",target:".error"},{target:"requesting"}]},initial:"initial",states:{initial:{},success:{},error:{}}},requesting:{invoke:{src:"request",id:"request",onDone:{target:"idle.success",actions:"reportSuccess"},onError:{actions:["saveRequestError","reportError"],target:"idle.error"}}}}},{actions:{saveInvalidEmailError:p({error:t=>k}),saveRequestError:p({error:(t,{data:{error:n}})=>n}),reportError:T(t=>({type:"ERROR",error:t.error})),reportSuccess:T("SUCCESS")},guards:{invalidEmail:(t,{email:n})=>!I(n)},services:{request:async(t,{email:n,options:i})=>(await r.post("/user/email/send-verification-email",{email:n,options:v(e,i)})).data}})},qe=({backendUrl:s,clientUrl:e,clientStorageGetter:r,clientStorageSetter:t,clientStorageType:n="web",clientStorage:i,refreshIntervalTime:l,autoRefreshToken:u=!0,autoSignIn:f=!0})=>{const g=r||be(n,i),m=t||Ce(n,i),E=C(s),h=async(o,a,c)=>(await E.post(o,a,c)).data;return b({schema:{context:{},events:{}},tsTypes:{},context:W,preserveActionOrder:!0,id:"nhost",type:"parallel",states:{authentication:{initial:"starting",on:{SESSION_UPDATE:[{cond:"hasSession",actions:["saveSession","resetTimer","reportTokenChanged"],target:".signedIn"}]},states:{starting:{entry:"resetErrors",tags:["loading"],always:{cond:"isSignedIn",target:"signedIn"},invoke:{id:"importRefreshToken",src:"importRefreshToken",onDone:{actions:["saveSession","reportTokenChanged"],target:"signedIn"},onError:{actions:["saveAuthenticationError"],target:"signedOut"}}},signedOut:{initial:"noErrors",entry:"reportSignedOut",states:{noErrors:{},success:{},needsSmsOtp:{},needsMfa:{},failed:{},signingOut:{entry:["clearContextExceptRefreshToken"],exit:["destroyRefreshToken","reportTokenChanged"],invoke:{src:"signout",id:"signingOut",onDone:{target:"success"},onError:{target:"failed",actions:["saveAuthenticationError"]}}}},on:{SIGNIN_PASSWORD:"authenticating.password",SIGNIN_ANONYMOUS:"authenticating.anonymous",SIGNIN_MFA_TOTP:"authenticating.mfa.totp"}},authenticating:{entry:"resetErrors",states:{password:{invoke:{src:"signInPassword",id:"authenticateUserWithPassword",onDone:[{cond:"hasMfaTicket",actions:["saveMfaTicket"],target:"#nhost.authentication.signedOut.needsMfa"},{actions:["saveSession","reportTokenChanged"],target:"#nhost.authentication.signedIn"}],onError:[{cond:"unverified",target:["#nhost.authentication.signedOut","#nhost.registration.incomplete.needsEmailVerification"]},{actions:"saveAuthenticationError",target:"#nhost.authentication.signedOut.failed"}]}},anonymous:{invoke:{src:"signInAnonymous",id:"authenticateAnonymously",onDone:{actions:["saveSession","reportTokenChanged"],target:"#nhost.authentication.signedIn"},onError:{actions:"saveAuthenticationError",target:"#nhost.authentication.signedOut.failed"}}},mfa:{states:{totp:{invoke:{src:"signInMfaTotp",id:"signInMfaTotp",onDone:{actions:["saveSession","reportTokenChanged"],target:"#nhost.authentication.signedIn"},onError:{actions:["saveAuthenticationError"],target:"#nhost.authentication.signedOut.failed"}}}}}}},signedIn:{type:"parallel",entry:["reportSignedIn","cleanUrl","broadcastToken","resetErrors"],on:{SIGNOUT:"signedOut.signingOut"},states:{refreshTimer:{id:"timer",initial:"idle",states:{disabled:{type:"final"},stopped:{always:{cond:"noToken",target:"idle"}},idle:{always:[{cond:"isAutoRefreshDisabled",target:"disabled"},{cond:"hasRefreshToken",target:"running"}]},running:{initial:"pending",entry:"resetTimer",states:{pending:{after:{1e3:{internal:!1,target:"pending"}},always:{cond:"refreshTimerShouldRefresh",target:"refreshing"}},refreshing:{invoke:{src:"refreshToken",id:"refreshToken",onDone:{actions:["saveSession","resetTimer","reportTokenChanged"],target:"pending"},onError:[{actions:"saveRefreshAttempt",target:"pending"}]}}}}}}}}}},token:{initial:"idle",states:{idle:{on:{TRY_TOKEN:"running"},initial:"noErrors",states:{noErrors:{},error:{}}},running:{invoke:{src:"refreshToken",id:"authenticateWithToken",onDone:{actions:["saveSession","reportTokenChanged"],target:["#nhost.authentication.signedIn","idle.noErrors"]},onError:[{cond:"isSignedIn",target:"idle.error"},{actions:"saveAuthenticationError",target:["#nhost.authentication.signedOut.failed","idle.error"]}]}}}},registration:{initial:"incomplete",on:{SIGNED_IN:[{cond:"isAnonymous",target:".incomplete"},".complete"]},states:{incomplete:{on:{SIGNUP_EMAIL_PASSWORD:"emailPassword",PASSWORDLESS_EMAIL:"passwordlessEmail",PASSWORDLESS_SMS:"passwordlessSms",PASSWORDLESS_SMS_OTP:"passwordlessSmsOtp"},initial:"noErrors",states:{noErrors:{},needsEmailVerification:{},needsOtp:{},failed:{}}},emailPassword:{entry:["resetErrors"],invoke:{src:"signUpEmailPassword",id:"signUpEmailPassword",onDone:[{cond:"hasSession",actions:["saveSession","reportTokenChanged"],target:"#nhost.authentication.signedIn"},{actions:"clearContext",target:["#nhost.authentication.signedOut","incomplete.needsEmailVerification"]}],onError:[{cond:"unverified",target:"incomplete.needsEmailVerification"},{actions:"saveRegistrationError",target:"incomplete.failed"}]}},passwordlessEmail:{entry:["resetErrors"],invoke:{src:"passwordlessEmail",id:"passwordlessEmail",onDone:{actions:"clearContext",target:["#nhost.authentication.signedOut","incomplete.needsEmailVerification"]},onError:{actions:"saveRegistrationError",target:"incomplete.failed"}}},passwordlessSms:{entry:["resetErrors"],invoke:{src:"passwordlessSms",id:"passwordlessSms",onDone:{actions:"clearContext",target:["#nhost.authentication.signedOut","incomplete.needsOtp"]},onError:{actions:"saveRegistrationError",target:"incomplete.failed"}}},passwordlessSmsOtp:{entry:["resetErrors"],invoke:{src:"passwordlessSmsOtp",id:"passwordlessSmsOtp",onDone:{actions:["saveSession","reportTokenChanged"],target:"#nhost.authentication.signedIn"},onError:{actions:"saveRegistrationError",target:"incomplete.failed"}}},complete:{on:{SIGNED_OUT:"incomplete"}}}}}},{actions:{reportSignedIn:T("SIGNED_IN"),reportSignedOut:T("SIGNED_OUT"),reportTokenChanged:T("TOKEN_CHANGED"),clearContext:p(()=>(m(D,null),m(U,null),_({},W))),clearContextExceptRefreshToken:p(({refreshToken:{value:o}})=>(m(D,null),N(_({},W),{refreshToken:{value:o}}))),saveSession:p({user:(o,{data:a})=>{var c;return(c=a==null?void 0:a.session)==null?void 0:c.user},accessToken:(o,{data:a})=>{var c,d;if(a.session.accessTokenExpiresIn){const O=new Date(Date.now()+a.session.accessTokenExpiresIn*1e3).toISOString();m(D,O)}else m(D,null);return{value:(c=a==null?void 0:a.session)==null?void 0:c.accessToken,expiresAt:new Date(Date.now()+((d=a==null?void 0:a.session)==null?void 0:d.accessTokenExpiresIn)*1e3)}},refreshToken:(o,{data:a})=>{var c;return m(U,a.session.refreshToken),{value:(c=a==null?void 0:a.session)==null?void 0:c.refreshToken}}}),saveMfaTicket:p({mfa:(o,a)=>{var c;return(c=a.data)==null?void 0:c.mfa}}),resetTimer:p({refreshTimer:(o,a)=>({startedAt:new Date,attempts:0,lastAttempt:null})}),saveRefreshAttempt:p({refreshTimer:(o,a)=>({startedAt:o.refreshTimer.startedAt,attempts:o.refreshTimer.attempts+1,lastAttempt:new Date})}),saveAuthenticationError:p({errors:({errors:o},{data:{error:a}})=>N(_({},o),{authentication:a})}),resetErrors:p({errors:o=>({})}),saveRegistrationError:p({errors:({errors:o},{data:{error:a}})=>N(_({},o),{registration:a})}),destroyRefreshToken:p({refreshToken:o=>(m(U,null),{value:null})}),cleanUrl:()=>{f&&x("refreshToken")&&(Y("refreshToken"),Y("type"))},broadcastToken:o=>{if(f)try{new BroadcastChannel("nhost").postMessage(o.refreshToken.value)}catch{}}},guards:{isAnonymous:(o,a)=>{var c;return!!((c=o.user)!=null&&c.isAnonymous)},isSignedIn:o=>!!o.user&&!!o.refreshToken.value&&!!o.accessToken.value,noToken:o=>!o.refreshToken.value,hasRefreshToken:o=>!!o.refreshToken.value,isAutoRefreshDisabled:()=>!u,refreshTimerShouldRefresh:o=>{const{expiresAt:a}=o.accessToken;return a?o.refreshTimer.lastAttempt?Date.now()-o.refreshTimer.lastAttempt.getTime()>_e*1e3:l&&Date.now()-o.refreshTimer.startedAt.getTime()>l*1e3?!0:a.getTime()-Date.now()-1e3*ve<=0:!1},unverified:(o,{data:{error:a}})=>a.status===401&&(a.message==="Email is not verified"||a.error==="unverified-user"),hasSession:(o,a)=>{var c;return!!((c=a.data)!=null&&c.session)},hasMfaTicket:(o,a)=>{var c;return!!((c=a.data)!=null&&c.mfa)}},services:{signInPassword:(o,{email:a,password:c})=>I(a)?z(c)?h("/signin/email-password",{email:a,password:c}):Promise.reject({error:F}):Promise.reject({error:k}),passwordlessSms:(o,{phoneNumber:a,options:c})=>{var d;return J(a)?(d=o.user)!=null&&d.isAnonymous?(console.warn("Deanonymisation from a phone number is not yet implemented in hasura-auth"),h("/user/deanonymize",{signInMethod:"passwordless",connection:"sms",phoneNumber:a,options:v(e,c)},{headers:{authorization:`Bearer ${o.accessToken.value}`}})):h("/signin/passwordless/sms",{phoneNumber:a,options:v(e,c)}):Promise.reject({error:Q})},passwordlessSmsOtp:(o,{phoneNumber:a,otp:c})=>J(a)?h("/signin/passwordless/sms/otp",{phoneNumber:a,otp:c}):Promise.reject({error:Q}),passwordlessEmail:(o,{email:a,options:c})=>{var d;return I(a)?(d=o.user)!=null&&d.isAnonymous?h("/user/deanonymize",{signInMethod:"passwordless",connection:"email",email:a,options:v(e,c)},{headers:{authorization:`Bearer ${o.accessToken.value}`}}):h("/signin/passwordless/email",{email:a,options:v(e,c)}):Promise.reject({error:k})},signInAnonymous:o=>h("/signin/anonymous"),signInMfaTotp:(o,a)=>{var c;const d=a.ticket||((c=o.mfa)==null?void 0:c.ticket);return d?Ue(d)?h("/signin/mfa/totp",{ticket:d,otp:a.otp}):Promise.reject({error:Se}):Promise.reject({error:Oe})},refreshToken:async(o,a)=>{const c=a.type==="TRY_TOKEN"?a.token:o.refreshToken.value;return{session:await h("/token",{refreshToken:c})}},signout:(o,a)=>h("/signout",{refreshToken:o.refreshToken.value,all:!!a.all}),signUpEmailPassword:async(o,{email:a,password:c,options:d})=>{var O;return I(a)?z(c)?(O=o.user)!=null&&O.isAnonymous?h("/user/deanonymize",{signInMethod:"email-password",email:a,password:c,options:v(e,d)},{headers:{authorization:`Bearer ${o.accessToken.value}`}}):h("/signup/email-password",{email:a,password:c,options:v(e,d)}):Promise.reject({error:F}):Promise.reject({error:k})},importRefreshToken:async()=>{let o=null;if(f){const c=x("refreshToken")||null;if(c)try{return{session:await h("/token",{refreshToken:c})}}catch(d){o=d.error}else{const d=x("error");if(d)return Promise.reject({error:{status:w,error:d,message:x("errorDescription")||d}})}}const a=await g(U);if(a)try{return{session:await h("/token",{refreshToken:a})}}catch(c){o=c.error}return Promise.reject({error:o})}}})};class Ve{constructor(e){var r=e,{clientStorageType:t="web",autoSignIn:n=!0,autoRefreshToken:i=!0,start:l=!0,backendUrl:u,clientUrl:f,devTools:g}=r,m=le(r,["clientStorageType","autoSignIn","autoRefreshToken","start","backendUrl","clientUrl","devTools"]);if(this._subscriptions=new Set,this.backendUrl=u,this.clientUrl=f,this.machine=qe(N(_({},m),{backendUrl:u,clientUrl:f,clientStorageType:t,autoSignIn:n,autoRefreshToken:i})),l&&(this.interpreter=P(this.machine,{devTools:g}),this.interpreter.start()),typeof window<"u"&&n)try{this._channel=new BroadcastChannel("nhost"),this._channel.addEventListener("message",E=>{var h;const o=(h=this.interpreter)==null?void 0:h.state.context.refreshToken.value;this.interpreter&&E.data!==o&&this.interpreter.send("TRY_TOKEN",{token:E.data})})}catch{}}get interpreter(){return this._interpreter}set interpreter(e){this._interpreter=e,e&&this._subscriptions.forEach(r=>r(this))}onStart(e){this.interpreter?e(this):this._subscriptions.add(e)}}const je=async(s,e,r)=>new Promise(t=>{s.send("REQUEST",{email:e,options:r}),s.onTransition(n=>{n.matches({idle:"error"})?t({error:n.context.error,isError:!0,needsEmailVerification:!1}):n.matches({idle:"success"})&&t({error:null,isError:!1,needsEmailVerification:!0})})}),Le=async(s,e)=>new Promise(r=>{s.send("REQUEST",{password:e}),s.onTransition(t=>{t.matches({idle:"error"})?r({error:t.context.error,isError:!0,isSuccess:!1}):t.matches({idle:"success"})&&r({error:null,isError:!1,isSuccess:!0})})}),Ge=async(s,e,r)=>new Promise(t=>{s.send("REQUEST",{email:e,options:r}),s.onTransition(n=>{n.matches({idle:"error"})?t({error:n.context.error,isError:!0,isSent:!1}):n.matches({idle:"success"})&&t({error:null,isError:!1,isSent:!0})})}),He=(s,e,r)=>new Promise(t=>{s.send("REQUEST",{email:e,options:r}),s.onTransition(n=>{n.matches({idle:"error"})?t({error:n.context.error,isError:!0,isSent:!1}):n.matches({idle:"success"})&&t({error:null,isError:!1,isSent:!0})})}),We=s=>new Promise(e=>{const{changed:r}=s.send("SIGNIN_ANONYMOUS");r||e({isSuccess:!1,isError:!0,error:S,user:null,accessToken:null}),s.onTransition(t=>{t.matches({authentication:"signedIn"})&&e({isSuccess:!0,isError:!1,error:null,user:t.context.user,accessToken:t.context.accessToken.value}),t.matches({authentication:{signedOut:"failed"}})&&e({isSuccess:!1,isError:!0,error:t.context.errors.authentication||null,user:null,accessToken:null})})}),Ke=(s,e,r)=>new Promise(t=>{const{changed:n,context:i}=s.send("SIGNIN_PASSWORD",{email:e,password:r});if(!n)return t({accessToken:i.accessToken.value,error:S,isError:!0,isSuccess:!1,needsEmailVerification:!1,needsMfaOtp:!1,mfa:null,user:i.user});s.onTransition(l=>{l.matches({authentication:{signedOut:"noErrors"},registration:{incomplete:"needsEmailVerification"}})?t({accessToken:null,error:null,isError:!1,isSuccess:!1,needsEmailVerification:!0,needsMfaOtp:!1,mfa:null,user:null}):l.matches({authentication:{signedOut:"needsMfa"}})?t({accessToken:null,error:null,isError:!1,isSuccess:!1,needsEmailVerification:!1,needsMfaOtp:!0,mfa:l.context.mfa,user:null}):l.matches({authentication:{signedOut:"failed"}})?t({accessToken:null,error:l.context.errors.authentication||null,isError:!0,isSuccess:!1,needsEmailVerification:!1,needsMfaOtp:!1,mfa:null,user:null}):l.matches({authentication:"signedIn"})&&t({accessToken:l.context.accessToken.value,error:null,isError:!1,isSuccess:!0,needsEmailVerification:!1,needsMfaOtp:!1,mfa:null,user:l.context.user})})}),X=(s,e,r)=>new Promise(t=>{const{changed:n}=s.send("PASSWORDLESS_EMAIL",{email:e,options:r});if(!n)return t({error:S,isError:!0,isSuccess:!1});s.onTransition(i=>{i.matches("registration.incomplete.failed")?t({error:i.context.errors.registration||null,isError:!0,isSuccess:!1}):i.matches({authentication:{signedOut:"noErrors"},registration:{incomplete:"needsEmailVerification"}})&&t({error:null,isError:!1,isSuccess:!0})})}),Fe=(s,e,r)=>new Promise(t=>{const{changed:n,context:i}=s.send("SIGNIN_MFA_TOTP",{otp:e,ticket:r});if(!n)return t({accessToken:i.accessToken.value,error:S,isError:!0,isSuccess:!1,user:i.user});s.onTransition(l=>{l.matches({authentication:{signedOut:"failed"}})?t({accessToken:null,error:l.context.errors.authentication||null,isError:!0,isSuccess:!1,user:null}):l.matches({authentication:"signedIn"})&&t({accessToken:l.context.accessToken.value,error:null,isError:!1,isSuccess:!0,user:l.context.user})})}),Z=(s,e,r)=>new Promise(t=>{const{changed:n}=s.send("PASSWORDLESS_SMS",{phoneNumber:e,options:r});if(!n)return t({error:S,isError:!0,isSuccess:!1,needsOtp:!1});s.onTransition(i=>{i.matches("registration.incomplete.needsOtp")?t({error:null,isError:!1,isSuccess:!1,needsOtp:!0}):i.matches("registration.incomplete.failed")&&t({error:i.context.errors.authentication||null,isError:!0,isSuccess:!1,needsOtp:!1})})}),ze=(s,e,r)=>new Promise(t=>{const{changed:n}=s.send("PASSWORDLESS_SMS_OTP",{phoneNumber:e,otp:r});if(!n)return t({error:S,isError:!0,isSuccess:!1,user:null,accessToken:null});s.onTransition(i=>{i.matches({authentication:"signedIn"})?t({error:null,isError:!1,isSuccess:!0,user:i.context.user,accessToken:i.context.accessToken.value}):i.matches({authentication:{signedOut:"failed"}})&&t({error:i.context.errors.authentication||null,isError:!0,isSuccess:!1,user:null,accessToken:null})})}),Be=async(s,e)=>new Promise(r=>{const{event:t}=s.send("SIGNOUT",{all:e});if(t.type!=="SIGNED_OUT")return r({isSuccess:!1,isError:!0,error:ye});s.onTransition(n=>{n.matches({authentication:{signedOut:"success"}})?r({isSuccess:!0,isError:!1,error:null}):n.matches("authentication.signedOut.failed")&&r({isSuccess:!1,isError:!0,error:n.context.errors.signout||null})})}),ee=(s,e,r,t)=>new Promise(n=>{const{changed:i,context:l}=s.send("SIGNUP_EMAIL_PASSWORD",{email:e,password:r,options:t});if(!i)return n({error:S,accessToken:l.accessToken.value,isError:!0,isSuccess:!1,needsEmailVerification:!1,user:l.user});s.onTransition(u=>{u.matches("registration.incomplete.failed")?n({accessToken:null,error:u.context.errors.registration||null,isError:!0,isSuccess:!1,needsEmailVerification:!1,user:null}):u.matches({authentication:{signedOut:"noErrors"},registration:{incomplete:"needsEmailVerification"}})?n({accessToken:null,error:null,isError:!1,isSuccess:!1,needsEmailVerification:!0,user:null}):u.matches({authentication:"signedIn",registration:"complete"})&&n({accessToken:u.context.accessToken.value,error:null,isError:!1,isSuccess:!0,needsEmailVerification:!1,user:u.context.user})})});var Qe=Object.defineProperty,Ye=Object.defineProperties,Je=Object.getOwnPropertyDescriptors,re=Object.getOwnPropertySymbols,Xe=Object.prototype.hasOwnProperty,Ze=Object.prototype.propertyIsEnumerable,te=(s,e,r)=>e in s?Qe(s,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[e]=r,$=(s,e)=>{for(var r in e||(e={}))Xe.call(e,r)&&te(s,r,e[r]);if(re)for(var r of re(e))Ze.call(e,r)&&te(s,r,e[r]);return s},M=(s,e)=>Ye(s,Je(e));const er=()=>typeof window<"u",q=s=>!s||!s.accessToken.value||!s.refreshToken.value||!s.accessToken.expiresAt||!s.user?null:{accessToken:s.accessToken.value,accessTokenExpiresIn:(s.accessToken.expiresAt.getTime()-Date.now())/1e3,refreshToken:s.refreshToken.value,user:s.user},A=({accessToken:s,isError:e,user:r,error:t})=>e?{session:null,error:t}:r&&s?{session:{accessToken:s,accessTokenExpiresIn:0,refreshToken:"TODO",user:r},error:null}:{session:null,error:null};class rr{constructor({url:e,autoRefreshToken:r=!0,autoSignIn:t=!0,autoLogin:n,clientStorage:i,clientStorageType:l,clientStorageGetter:u,clientStorageSetter:f,refreshIntervalTime:g,start:m=!0}){var E;this._client=new Ve({backendUrl:e,clientUrl:typeof window<"u"&&((E=window.location)==null?void 0:E.origin)||"",autoRefreshToken:r,autoSignIn:typeof n=="boolean"?n:t,start:m,clientStorage:i,clientStorageType:l,clientStorageGetter:u,clientStorageSetter:f,refreshIntervalTime:g})}async signUp({email:e,password:r,options:t}){const n=await this.waitUntilReady();return A(await ee(n,e,r,t))}async signIn(e){const r=await this.waitUntilReady();if("provider"in e){const{provider:n,options:i}=e,l=ue(`${this._client.backendUrl}/signin/provider/${n}`,v(this._client.clientUrl,i));return er()&&(window.location.href=l),{providerUrl:l,provider:n,session:null,mfa:null,error:null}}if("email"in e&&"password"in e){const n=await Ke(r,e.email,e.password);return n.needsEmailVerification?{session:null,mfa:null,error:Ae}:n.needsMfaOtp?{session:null,mfa:n.mfa,error:null}:M($({},A(n)),{mfa:null})}if("email"in e){const{error:n}=await X(r,e.email);return{session:null,mfa:null,error:n}}if("phoneNumber"in e&&"otp"in e){const n=await ze(r,e.phoneNumber,e.otp);return M($({},A(n)),{mfa:null})}if("phoneNumber"in e){const{error:n}=await Z(r,e.phoneNumber,e.options);return{error:n,mfa:null,session:null}}if("otp"in e){const n=await Fe(r,e.otp,e.ticket);return M($({},A(n)),{mfa:null})}const t=await We(r);return M($({},A(t)),{mfa:null})}async signOut(e){const r=await this.waitUntilReady(),{error:t}=await Be(r,e==null?void 0:e.all);return{error:t}}async resetPassword({email:e,options:r}){const t=P($e(this._client)).start(),{error:n}=await Ge(t,e,r);return{error:n}}async changePassword({newPassword:e}){const r=P(xe(this._client)).start(),{error:t}=await Le(r,e);return{error:t}}async sendVerificationEmail({email:e,options:r}){const t=P(Me(this._client)).start(),{error:n}=await He(t,e,r);return{error:n}}async changeEmail({newEmail:e,options:r}){const t=P(De(this._client)).start(),{error:n}=await je(t,e,r);return{error:n}}async deanonymize(e){const r=await this.waitUntilReady();if(e.signInMethod==="passwordless"){if(e.connection==="email"){const{error:t}=await X(r,e.email,e.options);return{error:t}}if(e.connection==="sms"){const{error:t}=await Z(r,e.phoneNumber,e.options);return{error:t}}}if(e.signInMethod==="email-password"){const{error:t}=await ee(r,e.email,e.password,e.options);return{error:t}}throw Error("Unknown deanonymization method")}onTokenChanged(e){const r=t=>t.onTransition(({event:n,context:i})=>{n.type==="TOKEN_CHANGED"&&e(q(i))});if(this._client.interpreter){const t=r(this._client.interpreter);return()=>t.stop()}else return this._client.onStart(t=>{r(t.interpreter)}),()=>{console.log("onTokenChanged was added before the interpreter started. Cannot unsubscribe listener.")}}onAuthStateChanged(e){const r=t=>t.onTransition(({event:n,context:i})=>{(n.type==="SIGNED_IN"||n.type==="SIGNED_OUT")&&e(n.type,q(i))});if(this._client.interpreter){const t=r(this._client.interpreter);return()=>t.stop()}else return this._client.onStart(t=>{r(t.interpreter)}),()=>{console.log("onAuthStateChanged was added before the interpreter started. Cannot unsubscribe listener.")}}isAuthenticated(){var e;return!!((e=this._client.interpreter)!=null&&e.state.matches({authentication:"signedIn"}))}async isAuthenticatedAsync(){return(await this.waitUntilReady()).state.matches({authentication:"signedIn"})}getAuthenticationStatus(){return this.isReady()?{isAuthenticated:this.isAuthenticated(),isLoading:!1}:{isAuthenticated:!1,isLoading:!0}}getJWTToken(){return this.getAccessToken()}getAccessToken(){var e,r;return(r=(e=this._client.interpreter)==null?void 0:e.state.context.accessToken.value)!=null?r:void 0}getDecodedAccessToken(){const e=this.getAccessToken();return e?fe(e):null}getHasuraClaims(){var e;return((e=this.getDecodedAccessToken())==null?void 0:e["https://hasura.io/jwt/claims"])||null}getHasuraClaim(e){var r;return((r=this.getHasuraClaims())==null?void 0:r[e.startsWith("x-hasura-")?e:`x-hasura-${e}`])||null}async refreshSession(e){try{const r=await this.waitUntilReady();return new Promise(t=>{const n=e||r.state.context.refreshToken.value;if(!n)return t({session:null,error:ke});const{changed:i}=r.send("TRY_TOKEN",{token:n});if(!i)return t({session:null,error:Ie});r.onTransition(l=>{l.matches({token:{idle:"error"}})?t({session:null,error:Pe}):l.event.type==="TOKEN_CHANGED"&&t({session:q(l.context),error:null})})})}catch(r){return{session:null,error:r.message}}}getSession(){var e,r;return q((r=(e=this._client.interpreter)==null?void 0:e.state)==null?void 0:r.context)}getUser(){var e,r,t;return((t=(r=(e=this._client.interpreter)==null?void 0:e.state)==null?void 0:r.context)==null?void 0:t.user)||null}waitUntilReady(){const r=this._client.interpreter;if(!r)throw Error("Auth interpreter not set");return r.state.hasTag("loading")?new Promise((t,n)=>{let i=setTimeout(()=>n("The state machine is not yet ready after 15 seconds."),15e3);r.onTransition(l=>{if(!l.hasTag("loading"))return clearTimeout(i),t(r)})}):Promise.resolve(r)}isReady(){var e,r;return!((r=(e=this._client.interpreter)==null?void 0:e.state)!=null&&r.hasTag("loading"))}get client(){return this._client}}var tr=Object.defineProperty,sr=Object.defineProperties,nr=Object.getOwnPropertyDescriptors,se=Object.getOwnPropertySymbols,ir=Object.prototype.hasOwnProperty,or=Object.prototype.propertyIsEnumerable,ne=(s,e,r)=>e in s?tr(s,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[e]=r,R=(s,e)=>{for(var r in e||(e={}))ir.call(e,r)&&ne(s,r,e[r]);if(se)for(var r of se(e))or.call(e,r)&&ne(s,r,e[r]);return s},de=(s,e)=>sr(s,nr(e));class ar{constructor({url:e}){this.url=e,this.httpClient=L.create({baseURL:this.url})}async upload(e){try{return{fileMetadata:(await this.httpClient.post("/files",e.file,{headers:de(R(R({},this.generateUploadHeaders(e)),this.generateAuthHeaders()),{"Content-Type":"multipart/form-data"})})).data,error:null}}catch(r){return{fileMetadata:null,error:r}}}async getPresignedUrl(e){try{const{fileId:r}=e;return{presignedUrl:(await this.httpClient.get(`/files/${r}/presignedurl`,{headers:R({},this.generateAuthHeaders())})).data,error:null}}catch(r){return{presignedUrl:null,error:r}}}async delete(e){try{const{fileId:r}=e;return await this.httpClient.delete(`/files/${r}`,{headers:R({},this.generateAuthHeaders())}),{error:null}}catch(r){return{error:r}}}setAccessToken(e){return this.accessToken=e,this}setAdminSecret(e){return this.adminSecret=e,this}generateUploadHeaders(e){const{bucketId:r,name:t,id:n}=e,i={};return r&&(i["x-nhost-bucket-id"]=r),n&&(i["x-nhost-file-id"]=n),t&&(i["x-nhost-file-name"]=t),i}generateAuthHeaders(){return!this.adminSecret&&!this.accessToken?null:this.adminSecret?{"x-hasura-admin-secret":this.adminSecret}:{Authorization:`Bearer ${this.accessToken}`}}}class cr{constructor({url:e,adminSecret:r}){this.url=e,this.api=new ar({url:e}),this.setAdminSecret(r)}async upload(e){const r=new FormData;r.append("file",e.file);const{fileMetadata:t,error:n}=await this.api.upload(de(R({},e),{file:r}));return n?{fileMetadata:null,error:n}:t?{fileMetadata:t,error:null}:{fileMetadata:null,error:new Error("Invalid file returned")}}getUrl(e){return this.getPublicUrl(e)}getPublicUrl(e){const{fileId:r}=e;return`${this.url}/files/${r}`}async getPresignedUrl(e){const{presignedUrl:r,error:t}=await this.api.getPresignedUrl(e);return t?{presignedUrl:null,error:t}:r?{presignedUrl:r,error:null}:{presignedUrl:null,error:new Error("Invalid file id")}}async delete(e){const{error:r}=await this.api.delete(e);return r?{error:r}:{error:null}}setAccessToken(e){return this.api.setAccessToken(e),this}setAdminSecret(e){return this.api.setAdminSecret(e),this}}var lr=Object.defineProperty,ur=Object.defineProperties,dr=Object.getOwnPropertyDescriptors,ie=Object.getOwnPropertySymbols,hr=Object.prototype.hasOwnProperty,fr=Object.prototype.propertyIsEnumerable,oe=(s,e,r)=>e in s?lr(s,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[e]=r,y=(s,e)=>{for(var r in e||(e={}))hr.call(e,r)&&oe(s,r,e[r]);if(ie)for(var r of ie(e))fr.call(e,r)&&oe(s,r,e[r]);return s},he=(s,e)=>ur(s,dr(e));class mr{constructor(e){const{url:r,adminSecret:t}=e;this.accessToken=null,this.adminSecret=t,this.instance=L.create({baseURL:r})}async call(e,r,t){const n=y(y({},this.generateAccessTokenHeaders()),t==null?void 0:t.headers);let i;try{i=await this.instance.post(e,r,he(y({},t),{headers:n}))}catch(l){if(l instanceof Error)return{res:null,error:l}}return i?{res:i,error:null}:{res:null,error:new Error("Unable to make post request to funtion")}}setAccessToken(e){if(!e){this.accessToken=null;return}this.accessToken=e}generateAccessTokenHeaders(){return this.adminSecret?{"x-hasura-admin-secret":this.adminSecret}:this.accessToken?{Authorization:`Bearer ${this.accessToken}`}:{}}}class pr{constructor(e){const{url:r,adminSecret:t}=e;this.url=r,this.accessToken=null,this.adminSecret=t,this.instance=L.create({baseURL:r})}async request(e,r,t){const n=y(y({},this.generateAccessTokenHeaders()),t==null?void 0:t.headers);try{const i="",u=(await this.instance.post("",{operationName:i||void 0,query:typeof e=="string"?e:me(e),variables:r},he(y({},t),{headers:n}))).data,{data:f}=u;return u.errors?{data:null,error:u.errors}:typeof f!="object"||Array.isArray(f)||f===null?{data:null,error:new Error("incorrect response data from GraphQL server")}:{data:f,error:null}}catch(i){return i instanceof Error?{data:null,error:i}:(console.error(i),{data:null,error:new Error("Unable to get do GraphQL request")})}}getUrl(){return this.url}setAccessToken(e){if(!e){this.accessToken=null;return}this.accessToken=e}generateAccessTokenHeaders(){return this.adminSecret?{"x-hasura-admin-secret":this.adminSecret}:this.accessToken?{Authorization:`Bearer ${this.accessToken}`}:{}}}let _r=class{constructor({backendUrl:e,refreshIntervalTime:r,clientStorageGetter:t,clientStorageSetter:n,clientStorage:i,clientStorageType:l,autoRefreshToken:u,autoSignIn:f,adminSecret:g,devTools:m,start:E=!0}){var h;if(!e)throw new Error("Please specify a `backendUrl`. Docs: [todo]!");this.auth=new rr({url:`${e}/v1/auth`,refreshIntervalTime:r,clientStorageGetter:t,clientStorageSetter:n,clientStorage:i,clientStorageType:l,autoRefreshToken:u,autoSignIn:f,start:E}),this.storage=new cr({url:`${e}/v1/storage`,adminSecret:g}),this.functions=new mr({url:`${e}/v1/functions`,adminSecret:g}),this.graphql=new pr({url:`${e}/v1/graphql`,adminSecret:g}),this.storage.setAccessToken(this.auth.getAccessToken()),this.functions.setAccessToken(this.auth.getAccessToken()),this.graphql.setAccessToken(this.auth.getAccessToken()),(h=this.auth.client)==null||h.onStart(()=>{this.auth.onAuthStateChanged((o,a)=>{o==="SIGNED_OUT"&&(this.storage.setAccessToken(void 0),this.functions.setAccessToken(void 0),this.graphql.setAccessToken(void 0))}),this.auth.onTokenChanged(o=>{this.storage.setAccessToken(o==null?void 0:o.accessToken),this.functions.setAccessToken(o==null?void 0:o.accessToken),this.graphql.setAccessToken(o==null?void 0:o.accessToken)})}),this.devTools=m}};export{_r as N};
